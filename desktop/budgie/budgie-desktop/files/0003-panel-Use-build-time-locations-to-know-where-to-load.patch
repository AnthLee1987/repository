From 7754cfd57e2e6eb722e1e7ee4107f3932d2c9914 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey.doherty@gmail.com>
Date: Sun, 20 Jul 2014 13:16:31 +0100
Subject: [PATCH 3/8] panel: Use build time locations to know where to load
 plugins from

---
 configure.ac           | 11 +++++++++++
 panel/BudgiePanel.vala |  2 +-
 panel/Makefile.am      | 12 +++++++++++-
 panel/panelconfig.h    |  9 +++++++++
 panel/panelconfig.vapi |  9 +++++++++
 5 files changed, 41 insertions(+), 2 deletions(-)
 create mode 100644 panel/panelconfig.h
 create mode 100644 panel/panelconfig.vapi

diff --git a/configure.ac b/configure.ac
index b2fa77c..dd20b3c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -22,6 +22,17 @@ PKG_CHECK_MODULES([GTK3], [gtk+-3.0 >= 3.10.0])
 
 PULSE_MIN_VERS=2.0
 
+MODULEDIR=${libdir}/budgie-desktop
+AC_SUBST(MODULEDIR)
+AC_DEFINE_UNQUOTED(MODULEDIR, "$MODULEDIR",
+                   [Installation directory for Budgie plugins])
+
+# Technically unused right now but might be used in the future
+MODULE_DATA_DIR=${datadir}/budgie-desktop/plugins
+AC_SUBST(MODULE_DATA_DIR)
+AC_DEFINE_UNQUOTED(MODULE_DATA_DIR, "$MODULEDIR",
+                   [Installation directory for Budgie plugin data])
+
 PKG_CHECK_MODULES(GVC, libpulse >= $PULSE_MIN_VERS libpulse-mainloop-glib gobject-2.0)
 
 # We require Mutter
diff --git a/panel/BudgiePanel.vala b/panel/BudgiePanel.vala
index 6c8ecd6..9236995 100644
--- a/panel/BudgiePanel.vala
+++ b/panel/BudgiePanel.vala
@@ -32,7 +32,7 @@ public class Panel : Gtk.Window
 
     /* Totally temporary - we'll extend to user plugins in the end and
      * ensure these directories are correct at compile time */
-    static string module_directory = "/usr/lib/budgie-desktop";
+    static string module_directory = MODULE_DIRECTORY;
     static string module_data_directory = "/usr/share/budgie-panel/plugins";
 
     public Panel()
diff --git a/panel/Makefile.am b/panel/Makefile.am
index 842dea1..9d48e8d 100644
--- a/panel/Makefile.am
+++ b/panel/Makefile.am
@@ -1,5 +1,7 @@
 -include $(top_srcdir)/common.mk
 
+EXTRA_DIST = 
+
 bin_PROGRAMS = budgie-panel
 
 budgie_panel_SOURCES = \
@@ -12,7 +14,9 @@ budgie_panel_CFLAGS = \
 	$(GOBJECT_CFLAGS) \
 	$(GTK3_CFLAGS) \
 	$(WNCK3_CFLAGS) \
-	$(LIBPEAS_CFLAGS)
+	$(LIBPEAS_CFLAGS) \
+	-DMODULE_DIR=\"$(MODULEDIR)\" \
+	-DMODULE_DATA_DIR=\"$(MODULE_DATA_DIR)\"
 
 budgie_panel_LDADD = \
 	$(GOBJECT_LIBS) \
@@ -23,6 +27,8 @@ budgie_panel_LDADD = \
 
 budgie_panel_VALAFLAGS = \
 	--vapidir=../budgie-plugin \
+	--vapidir=. \
+	--pkg panelconfig \
 	--pkg gtk+-3.0 \
 	--pkg libwnck-3.0 \
 	--pkg gio-unix-2.0 \
@@ -30,5 +36,9 @@ budgie_panel_VALAFLAGS = \
 	--pkg budgie-1.0 \
 	--pkg PeasGtk-1.0
 
+EXTRA_DIST += \
+	panelconfig.h \
+	panelconfig.vapi
+
 SUBDIRS = \
 	applets
diff --git a/panel/panelconfig.h b/panel/panelconfig.h
new file mode 100644
index 0000000..93ee817
--- /dev/null
+++ b/panel/panelconfig.h
@@ -0,0 +1,9 @@
+#ifndef BUDGIE_PANEL_CONFIG_H
+#define BUDGIE_PANEL_CONFIG_H
+
+/* i.e. /usr/lib/budgie-desktop */
+const char *BUDGIE_MODULE_DIRECTORY = MODULE_DIR;
+
+/* i.e. /usr/share/budgie-desktop/plugins */
+const char *BUDGIE_MODULE_DATA_DIRECTORY = MODULE_DATA_DIR;
+#endif
diff --git a/panel/panelconfig.vapi b/panel/panelconfig.vapi
new file mode 100644
index 0000000..672901b
--- /dev/null
+++ b/panel/panelconfig.vapi
@@ -0,0 +1,9 @@
+/* budgie-1.0.vapi generated by valac 0.22.1, do not modify. */
+
+namespace Budgie {
+	[CCode (cheader_filename = "panelconfig.h")]
+    public extern const string MODULE_DIRECTORY;
+
+	[CCode (cheader_filename = "panelconfig.h")]
+    public extern const string MODULE_DATA_DIRECTORY;
+}
-- 
1.9.1

