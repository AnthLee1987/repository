# HG changeset patch
# Parent fc4a918536a57ef67bc8cd756a09261157a1b291
Add progress reporting to pisi backend

diff -r fc4a918536a5 backends/pisi/pisiBackend.py
--- a/backends/pisi/pisiBackend.py	Sat Jun 08 02:48:26 2013 +0100
+++ b/backends/pisi/pisiBackend.py	Sat Jun 08 12:25:34 2013 +0100
@@ -20,11 +20,20 @@
 # Copyright (C) 2007 S.Çağlar Onur <caglar@pardus.org.tr>
 
 import pisi
+import pisi.ui
 from packagekit.backend import *
 from packagekit.package import PackagekitPackage
 from packagekit import enums
 import os.path
 
+class SimplePisiHandler(pisi.ui.UI):
+    
+    def __init(self):
+        pisi.ui.UI.__init__(self, False, False)
+        
+    def display_progress (self, **ka):
+        self.the_callback (**ka)
+
 class PackageKitPisiBackend(PackageKitBaseBackend, PackagekitPackage):
         
     MAPPING_FILE = "/etc/PackageKit/pisi.conf"
@@ -218,13 +227,21 @@
         # FIXME: use only_trusted
 
         package = self.get_package_from_id(package_ids[0])[0]
+        
+        def progress_cb (**kw):			
+            self.percentage (int(kw['percent']))
+            
+        ui = SimplePisiHandler ()
 
         if self.packagedb.has_package(package):
             self.status(STATUS_INSTALL)
+            pisi.api.set_userinterface (ui)
+            ui.the_callback = progress_cb
             try:
                 pisi.api.install([package])
             except pisi.Error,e:
                 self.error(ERROR_UNKNOWN, e)
+            pisi.api.set_userinterface (None)
         else:
             self.error(ERROR_PACKAGE_NOT_INSTALLED, "Package is already installed")
 
@@ -251,15 +268,23 @@
         self.percentage(None)
         # TODO: use autoremove
 
+        def progress_cb (**kw):			
+            self.percentage (int(kw['percent']))
+            
+        ui = SimplePisiHandler ()
+        
         package = self.get_package_from_id(package_ids[0])[0]
 
         if self.installdb.has_package(package):
             self.status(STATUS_REMOVE)
+            pisi.api.set_userinterface (ui)
+            ui.the_callback = progress_cb
             try:
                 pisi.api.remove([package])
             except pisi.Error,e:
                 # system.base packages cannot be removed from system
                 self.error(ERROR_CANNOT_REMOVE_SYSTEM_PACKAGE, e)
+            pisi.api.set_userinterface (None)
         else:
             self.error(ERROR_PACKAGE_NOT_INSTALLED, "Package is not installed")
 
